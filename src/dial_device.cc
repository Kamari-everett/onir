#include "dial_device.h"

#include "Arduino.h"

DialDevice::DialDevice(const Hardware& hardware) : hardware(hardware) {
  init();
}

void DialDevice::init() {
  if (not unset(hardware)) {
    pinMode(dispatch(hardware, PinFunction::CLOCK),  INPUT_PULLUP);
    pinMode(dispatch(hardware, PinFunction::DATA),  INPUT_PULLUP);
    pinMode(dispatch(hardware, PinFunction::SWITCH),  INPUT_PULLUP);
  }
  // assume the recent past was boring.
  clock = true;
}

bool DialDevice::clock_pin() const {
  return digitalRead(dispatch(hardware, PinFunction::CLOCK));
}

bool DialDevice::data_pin() const {
  return digitalRead(dispatch(hardware, PinFunction::DATA));
}

bool DialDevice::switch_pressed() const {
  return not digitalRead(dispatch(hardware, PinFunction::SWITCH));
}

void DialDevice::read(DialState& state) {
  bool old_clock = clock;
  clock = clock_pin();
  if (clock != old_clock) {
    if (clock) {  // rising edge only
      if (data_pin()) {
        if (switch_pressed()) {
          state.down_count--;
        } else {
          state.count--;
        }
      } else {
        if (switch_pressed()) {
          state.down_count++;
        } else {
          state.count++;
        }
      }
    }
  }

  state.button = switch_pressed();
}
